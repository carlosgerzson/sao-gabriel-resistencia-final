<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <title>Cesium 3D</title>
    <style type="text/css">
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100% !important;
            height: 100% !important;
        }

        .img-prefeito {
            width: 300px;
            height: 400px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }
        .img-lenda {
            width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }
        .img-building {
            width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }
        /* Esconder o rodapé/credit do Cesium em telas pequenas (mobile) para evitar quebra de layout */
        @media (max-width: 600px) {
            /* O widget de crédito do Cesium contém links; selecionamos por seletor genérico e por href */
            .cesium-viewer-bottom, .cesium-viewer .cesium-credit {
                display: none !important;
            }
            /* alternativa mais específica: esconder apenas links para cesium.com, se existirem */
            a[href*="cesium.com"] { display: none !important; }
        }
        /* Esconder botões / widgets no topo direito do Cesium (desktop e mobile) */
        /* Isto remove: pesquisa (geocoder), Home, SceneMode (plane/curve), e botão de ajuda (interrogação) */
        .cesium-viewer .cesium-viewer-toolbar,
        .cesium-geocoder-container,
        .cesium-geocoder,
        .cesium-viewer .cesium-sceneModePicker,
        .cesium-sceneModePicker,
        .cesium-viewer .cesium-navigationHelpButton,
        .cesium-navigationHelpButton,
        .cesium-viewer .cesium-homeButton,
        .cesium-homeButton,
        /* seletores alternativos por atributo/title (fallback) */
        .cesium-viewer .cesium-button[title*="Home"],
        .cesium-viewer .cesium-button[title*="Search"],
        .cesium-viewer .cesium-button[title*="Help"]
        {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    
    <!-- Painel lateral agrupando os botões de controle -->
    <div id="left-panel" style="position:fixed;top:45px;left:5px;z-index:2;display:flex;flex-direction:column;gap:8px;">
        <!-- Botão 'Todos' controla a visibilidade dos controles abaixo -->
        <button id="todos-btn" aria-expanded="true" style="background:#ffd;border:1px solid #888;padding:6px 10px;border-radius:6px;font-weight:600;">Todos ▾</button>
        <div id="left-controls" style="display:flex;flex-direction:column;gap:8px;overflow:hidden;transition:max-height 0.28s ease;">
            <button id="toggle-osm-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;display:none;">Mostrar/ocultar OSM</button>
            <button id="mapa-tratados-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">Mapa SG_tratados</button>
            <button id="mapa-1930-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">Mapa SG_1930</button>
            <!-- Tourism buttons (simplified) -->
            <button id="tourism-list-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">Lista Turismo</button>
            <button id="tourism-toggle-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">marcadores Turismo (8)</button>
            <!-- Botões fixos adicionais -->
            <button id="marechais-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">Marechais</button>
            <button id="ilustres-btn" style="background:#ffe;border:1px solid #888;padding:6px 10px;border-radius:6px;">Homens Ilustres</button>
        </div>
    </div>
        <!-- Botão fixo de boas-vindas -->
        <button id="welcome-btn" style="position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:100;background:#333;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Bem Vindo</button>
    <!--<select id="category-selector" style="z-index: 1; position: fixed; top: 5px; left: 5px;">

    </select>-->





    <script type="module">

    console.log('Script carregado');

    import { buildingsMap } from './buildingsData.js';
    import { lendas } from './lendasData.js';
    import { prefeitos } from './prefeitosData.js';
    import { marechaisData } from './marechaisData.js';
    import { tourismPoints } from './tourismData.js';
    import { ilustres } from './ilustresData.js';


        // Função para adicionar um mapa histórico como plano
        function addMapaHistorico(viewer, url, largura_m = 300) {
            const proporcao = 2048 / 1380;
            const altura_m = largura_m / proporcao;
            // Conversão metros para graus
            const largura_graus = largura_m / 92000;
            const altura_graus = altura_m / 111000;
            const centerLon = -54.316974;
            const centerLat = -30.340808;
            const rectangle = Cesium.Rectangle.fromDegrees(
                centerLon - largura_graus / 2,
                centerLat - altura_graus / 2,
                centerLon + largura_graus / 2,
                centerLat + altura_graus / 2
            );
            return viewer.entities.add({
                name: url,
                rectangle: {
                    coordinates: rectangle,
                    material: url,
                    height: 35, // elevação acima das OSM/GLB
                    heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                    outline: true,
                    outlineColor: Cesium.Color.YELLOW.withAlpha(0.5),
                    fill: true,
                    alpha: 0.85
                }
            });
        }
        let mapaHistoricoAtual = null;
        let mapaHistoricoNome = null;
        function mostrarOuOcultarMapaHistorico(nomeArquivo) {
            // Se já está visível este mapa, oculta
            if (mapaHistoricoAtual && mapaHistoricoNome === nomeArquivo) {
                viewer.entities.remove(mapaHistoricoAtual);
                mapaHistoricoAtual = null;
                mapaHistoricoNome = null;
                return;
            }
            // Se outro mapa está visível, remove
            if (mapaHistoricoAtual) viewer.entities.remove(mapaHistoricoAtual);
            mapaHistoricoAtual = addMapaHistorico(viewer, nomeArquivo);
            mapaHistoricoNome = nomeArquivo;
        }

        let viewer;
    async function init() {
            // ...existing code...
            try {
                // Inicializa o visualizador com Cesium World Terrain
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    infoBox: false,
                    selectionIndicator: false,
                    animation: false,
                    timelcnine: false,
                    baseLayerPicker: false,
                });


                // Controles da câmera
                viewer.scene.screenSpaceCameraController.rotateEventTypes = [Cesium.CameraEventType.LEFT_DRAG];
                viewer.scene.screenSpaceCameraController.zoomEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG, Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
                viewer.scene.screenSpaceCameraController.panEventTypes = [Cesium.CameraEventType.RIGHT_DRAG];

                // Visão global e depois área de interesse (centro da praça)
                const pracaCentro = { lon: -54.316822, lat: -30.344800, altura: 600 };
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, 20000000),
                });
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, pracaCentro.altura),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0
                    },
                    duration: 3.5,
                    easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT,
                    complete: function() {
                        // Depois do flyTo inicial, mostra a caixa de boas-vindas
                        try { showWelcomeBox(); } catch (e) { console.warn('Erro ao mostrar welcome box', e); }
                    }
                });

                // Garante que as sombras estejam ativas
                viewer.shadows = true;

                // Botões para alternar mapas históricos
                document.getElementById('mapa-tratados-btn').onclick = () => {
                    mostrarOuOcultarMapaHistorico('SG_tratados.jpg');
                };
                document.getElementById('mapa-1930-btn').onclick = () => {
                    mostrarOuOcultarMapaHistorico('SG_1930.jpg');
                };
                // Botão 'Todos' que expande/colapsa os controles do painel esquerdo
                const todosBtn = document.getElementById('todos-btn');
                const leftControls = document.getElementById('left-controls');
                // Inicializa max-height para permitir transição (expandido por padrão)
                if (leftControls) {
                    leftControls.style.maxHeight = leftControls.scrollHeight + 'px';
                }
                if (todosBtn && leftControls) {
                    todosBtn.onclick = () => {
                        const isExpanded = todosBtn.getAttribute('aria-expanded') === 'true';
                        if (isExpanded) {
                            // colapsa
                            leftControls.style.maxHeight = '0px';
                            todosBtn.setAttribute('aria-expanded', 'false');
                            todosBtn.innerText = 'Todos ▸';
                        } else {
                            // expande para o tamanho do conteúdo
                            leftControls.style.maxHeight = leftControls.scrollHeight + 'px';
                            todosBtn.setAttribute('aria-expanded', 'true');
                            todosBtn.innerText = 'Todos ▾';
                        }
                    };
                }
                // Tourism UI (simplified)
                document.getElementById('tourism-list-btn').onclick = () => {
                    showTourismListModal();
                };

                // Função que cria a caixa de boas-vindas centralizada com conteúdo da prefeitura
                function showWelcomeBox() {
                    const existing = document.getElementById('welcome-box');
                    if (existing) return; // já visível
                    const box = document.createElement('div');
                    box.id = 'welcome-box';
                    box.style.position = 'fixed';
                    box.style.left = '50%';
                    box.style.top = '50%';
                    box.style.transform = 'translate(-50%,-50%)';
                    box.style.zIndex = 200;
                    box.style.width = '520px';
                    box.style.maxWidth = '95vw';
                    box.style.maxHeight = '70vh';
                    box.style.overflowY = 'auto';
                    box.style.background = '#333';
                    box.style.color = '#f5f5f5';
                    box.style.padding = '16px';
                    box.style.borderRadius = '10px';
                    box.style.boxShadow = '0 4px 30px rgba(0,0,0,0.4)';
                    box.style.fontFamily = 'sans-serif';
                    box.innerHTML = `
                        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;'>
                            <div style='font-size:18px;font-weight:700;color:#f5f5f5;'>Bem-vindo a São Gabriel</div>
                            <div style='display:flex;gap:8px;align-items:center;'>
                                <a href='https://www.saogabriel.rs.gov.br/pagina/historia' target='_blank' style='font-size:12px;color:#9fd;text-decoration:underline;'>Fonte: Prefeitura</a>
                                <button id='welcome-close' style='background:transparent;color:#f5f5f5;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;'>Fechar</button>
                            </div>
                        </div>
                        <div style='font-size:14px;color:#f5f5f5;line-height:1.4;'>
                            <div style='margin-bottom:12px;'>
                                <b>1) Origem do nome da cidade</b>
                                <p style='margin-top:6px;'>Quando se pronuncia o nome “São Gabriel” naturalmente atenta-se somente sobre o nome do município. O nome é uma homenagem ao Vice-Rei do Rio da Prata em 1800, Dom Gabriel. A primeira povoação foi fundada no Cerro do Batovi por Félix de Azara, e em 4 de abril de 1846 foi elevada a vila — data considerada a de emancipação.</p>
                            </div>
                            <div>
                                <b>2) Conheça melhor São Gabriel</b>
                                <p style='margin-top:6px;'>A região combina paisagens de coxilhas e várzeas, com forte vocação pecuária e arrozicultura, e possui atrativos naturais como o conjunto de formações rochosas na Palma e pontos hidrográficos singulares no distrito do Batovi. A cidade tem tradição militar — 'Terra dos Marechais' — e forte relevância histórica e cultural.</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(box);
                    document.getElementById('welcome-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                }

                    // Injetar CSS responsivo para mobile (aplica-se especialmente à caixa de boas-vindas e infoboxes)
                    (function injectMobileStyles() {
                        const styleId = 'mobile-responsive-styles';
                        if (document.getElementById(styleId)) return;
                        const css = `
                            @media (max-width: 480px) {
                                /* Caixa de boas-vindas - ocupa maior altura e largura reduzida */
                                #welcome-box {
                                    left: 50% !important;
                                    top: 5% !important;
                                    transform: translateX(-50%) !important;
                                    width: 95vw !important;
                                    max-width: 95vw !important;
                                    height: 85vh !important;
                                    max-height: 85vh !important;
                                    overflow: auto !important;
                                    padding: 12px !important;
                                    border-radius: 10px !important;
                                    box-shadow: 0 6px 40px rgba(0,0,0,0.6) !important;
                                    z-index: 200 !important;
                                }
                                /* Tornar botões e textos maiores para touch */
                                #welcome-box button, #welcome-box a {
                                    padding: 10px 12px !important;
                                    font-size: 15px !important;
                                    border-radius: 8px !important;
                                }

                                
                                /* Ajuste geral dos infoboxes para layout em coluna e conteúdo rolável */
                                #infobox, #prefeitos-box, #marechais-box, #ilustres-box, #infobox-lenda, #tourism-infobox, #tourism-list-modal {
                                    left: 50% !important;
                                    right: auto !important;
                                    top: 4% !important;
                                    transform: translateX(-50%) !important;
                                    width: 95vw !important;
                                    max-width: 95vw !important;
                                    /* Aumenta um pouco a altura no mobile para garantir que o botão Fechar fique visível */
                                    height: 92vh !important;
                                    max-height: 92vh !important;
                                    overflow: hidden !important; /* container principal não rola; conteúdo interno rola */
                                    border-radius: 10px !important;
                                    padding: 12px !important;
                                    box-sizing: border-box !important;
                                    z-index: 200 !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                }

                                /* Conteúdo interno (primeiro filho) fica rolável; botão de fechar fica fixo na base do container */
                                #infobox > div, #prefeitos-box > div, #marechais-box > div, #ilustres-box > div, #infobox-lenda > div, #tourism-infobox > div, #tourism-list-modal > div {
                                    overflow: auto !important;
                                    flex: 1 1 auto !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                }

                                /* Garante que as imagens não ocupem espaço excessivo e empurrem o botão para fora */
                                .img-building, .img-prefeito, .img-lenda {
                                    /* reduzimos um pouco a altura das imagens para abrir espaço para botões */
                                    max-height: calc(34vh) !important;
                                    width: auto !important;
                                    object-fit: contain !important;
                                    display: block !important;
                                    margin: 0 auto !important;
                                }

                                /* Botões de ação/fechar ficam visíveis e centralizados na base */
                                #marechais-box button#marechais-close,
                                #ilustres-box button#ilustres-close,
                                #prefeitos-box button#prefeitos-close,
                                #infobox button#close-infobox,
                                #infobox-lenda button#close-infobox-lenda,
                                #tourism-list-modal button#close-tourism-list {
                                    align-self: center !important;
                                    margin-top: 12px !important;
                                    flex-shrink: 0 !important;
                                }
                            }
                        `;
                        const st = document.createElement('style');
                        st.id = styleId;
                        st.appendChild(document.createTextNode(css));
                        document.head.appendChild(st);
                    })();

                    // Handler do botão fixo 'Bem Vindo'
                const wb = document.getElementById('welcome-btn');
                if (wb) wb.onclick = () => { showWelcomeBox(); };

                // Atacha handler ao botão estático 'Homens Ilustres'
                const ilustresBtn = document.getElementById('ilustres-btn');
                if (ilustresBtn) ilustresBtn.onclick = () => { showIlustresCarousel(); };

                let tourismMarkersVisible = false;
                let tourismEntities = [];
                document.getElementById('tourism-toggle-btn').onclick = () => {
                    tourismMarkersVisible = !tourismMarkersVisible;
                    if (tourismMarkersVisible) addTourismMarkers();
                    else removeTourismMarkers();
                };

                function addTourismMarkers() {
                    if (!viewer) return;
                    removeTourismMarkers();
                    tourismPoints.forEach(p => {
                        // billboard principal (maior)
                        const ent = viewer.entities.add({
                            id: p.id,
                            position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 5),
                            billboard: {
                                image: p.icon || 'https://cdn-icons-png.flaticon.com/512/149/149060.png',
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                width: 48,
                                height: 48
                            },
                            tourismId: p.id
                        });
                        // sombra (ellipse) ligeiramente abaixo do solo
                        const shadow = viewer.entities.add({
                            id: p.id + '_shadow',
                            position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 0.5),
                            ellipse: {
                                semiMajorAxis: 6.0,
                                semiMinorAxis: 3.5,
                                material: Cesium.Color.BLACK.withAlpha(0.25),
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            }
                        });
                        tourismEntities.push(ent);
                        tourismEntities.push(shadow);
                    });
                }

                function removeTourismMarkers() {
                    tourismEntities.forEach(e => viewer.entities.remove(e));
                    tourismEntities = [];
                }

                function showTourismListModal() {
                    let old = document.getElementById('tourism-list-modal');
                    if (old) old.parentNode.removeChild(old);
                    const modal = document.createElement('div');
                    modal.id = 'tourism-list-modal';
                    modal.style.position = 'fixed';
                    modal.style.top = '80px';
                    modal.style.right = '20px';
                    modal.style.setProperty('background', '#666', 'important');
                    modal.style.setProperty('color', '#fff', 'important');
                    modal.style.padding = '12px';
                    modal.style.zIndex = 60;
                    modal.style.border = '1px solid #666';
                    modal.style.borderRadius = '8px';
                    modal.style.maxHeight = '70vh';
                    modal.style.overflowY = 'auto';
                    modal.style.minWidth = '220px';
                    modal.style.fontSize = '14px';
                    modal.innerHTML = `<div style='font-weight:bold;margin-bottom:8px;'>Pontos Turísticos</div>`;
                    tourismPoints.forEach(p => {
                        const item = document.createElement('div');
                        item.style.marginBottom = '6px';
                        item.innerHTML = `<div style='font-weight:bold;'>${p.name}</div>
                            <div style='display:flex;gap:6px;margin-top:4px;align-items:center;'>
                                <button data-id='${p.id}' class='open-page' style='padding:4px 6px;font-size:13px;'>Abrir página</button>
                                ${p.infoUrl ? `<a href='${p.infoUrl}' target='_blank' style='color:#9fd;margin-left:6px;text-decoration:underline;font-size:13px;'>Mais informações</a>` : ''}
                            </div>`;
                        modal.appendChild(item);
                    });
                    const closeBtn = document.createElement('div');
                    closeBtn.style.marginTop = '8px';
                    closeBtn.innerHTML = `<button id='close-tourism-list' style='padding:6px 10px;'>Fechar</button>`;
                    modal.appendChild(closeBtn);
                    document.body.appendChild(modal);
                    modal.querySelectorAll('.open-page').forEach(b => b.onclick = (e) => {
                        const id = e.target.getAttribute('data-id');
                        const p = tourismPoints.find(x => x.id === id);
                        if (p && p.pageUrl) window.open(p.pageUrl, '_blank');
                    });
                    // apenas abre páginas individuais
                    document.getElementById('close-tourism-list').onclick = () => { if (modal.parentNode) modal.parentNode.removeChild(modal); };
                    modal.querySelectorAll('.open-page').forEach(b => b.onclick = (e) => {
                        const id = e.target.getAttribute('data-id');
                        const p = tourismPoints.find(x => x.id === id);
                        if (p && p.pageUrl) window.open(p.pageUrl, '_blank');
                    });
                }
               

                // Adiciona marcadores das lendas
                const lendaEntities = [];
                // Marcador para carrossel de prefeitos (sobre a prefeitura)
                const prefeituraData = buildingsMap['494741651'];
                let prefeitosMarker = null;
                if (prefeituraData) {
                    prefeitosMarker = viewer.entities.add({
                        id: 'prefeitura_prefeitos_marker',
                        position: prefeituraData.position,
                        billboard: {
                            image: 'https://cdn-icons-png.flaticon.com/512/1828/1828884.png', // ícone diferente
                            width: 42,
                            height: 42,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        }
                    });
                }

                // Botão para Marechais (abre carrossel)
                const marechaisBtn = document.createElement('button');
                marechaisBtn.id = 'marechais-btn';
                marechaisBtn.textContent = 'Marechais';
                marechaisBtn.style.position = 'fixed';
                marechaisBtn.style.top = '290px';
                marechaisBtn.style.left = '5px';
                marechaisBtn.style.zIndex = '2';
                marechaisBtn.style.background = '#efe';
                marechaisBtn.style.border = '1px solid #888';
                marechaisBtn.style.padding = '4px 8px';
                marechaisBtn.style.borderRadius = '6px';
                // Atacha handler ao botão estático 'Marechais'
                const marechaisBtnStatic = document.getElementById('marechais-btn');
                if (marechaisBtnStatic) marechaisBtnStatic.onclick = () => { showMarechaisCarousel(); };
                // Função para mostrar carrossel/infobox dos Marechais
                function showMarechaisCarousel(startIndex = 0) {
                    if (!marechaisData || !marechaisData.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), marechaisData.length - 1);
                    let oldBox = document.getElementById('marechais-box');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'marechais-box';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                        box.style.right = '20px';
                    box.style.setProperty('background', '#333', 'important');
                    box.style.setProperty('color', '#fff', 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                        box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);
                    window.addEventListener('keydown', keyHandler);
                    function keyHandler(e) {
                        if (box.style.display !== 'block') return;
                        if (e.key === 'ArrowRight') { idx = (idx + 1) % marechaisData.length; render(); }
                        if (e.key === 'ArrowLeft') { idx = (idx - 1 + marechaisData.length) % marechaisData.length; render(); }
                    }
                    function render() {
                        const m = marechaisData[idx];
                        const foto = m.foto ? m.foto : 'placeholder_prefeito.jpg';
                        let zebra = '';
                        if (m.resumo) {
                            let descParts = m.resumo.split(/<br\s*\/?>/);
                            zebra = descParts.map((part, i) => `<div style='background:${i%2===0?'#333':'#292929'};color:#fff;padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                        }
                        if (m.observacao) {
                            zebra += `<div style='margin-top:6px;'><b>Obs.:</b></div>`;
                            zebra += `<div style='background:#292929;color:#fff;padding:2px 6px;border-radius:3px;'>${m.observacao}</div>`;
                        }
                        box.innerHTML = `
                            <div style='text-align:center;color:#fff;'>
                                <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>Marechais de São Gabriel</div>
                                <b style='font-size:17px;'>${m.nome}</b><br><br>
                                <img src='${foto}' alt='${m.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:#444;'>
                                <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebra}</div>
                                <div style='display:flex;justify-content:space-between;margin-top:12px;'>
                                    <button id='marechais-prev' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#aaf;'>${idx + 1} / ${marechaisData.length}</span>
                                    <button id='marechais-next' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                                <button id='marechais-close' style='margin-top:14px;background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button>
                            </div>`;
                        document.getElementById('marechais-prev').onclick = () => { idx = (idx - 1 + marechaisData.length) % marechaisData.length; render(); };
                        document.getElementById('marechais-next').onclick = () => { idx = (idx + 1) % marechaisData.length; render(); };
                        document.getElementById('marechais-close').onclick = () => {
                            if (box.parentNode) box.parentNode.removeChild(box);
                            window.removeEventListener('keydown', keyHandler);
                        };
                        setTimeout(() => {
                            box.style.transform = 'translateX(0)';
                            box.style.opacity = '1';
                            box.style.display = 'block';
                        }, 10);
                    }
                    render();
                }

                function showPrefeitosCarousel(startIndex = 0) {
                    if (!prefeitos || !prefeitos.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), prefeitos.length - 1);
                    // Sempre remove o box anterior, se existir, para garantir animação
                    let oldBox = document.getElementById('prefeitos-box');
                    if (oldBox) {
                        oldBox.parentNode.removeChild(oldBox);
                    }
                    let box = document.createElement('div');
                    box.id = 'prefeitos-box';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                        box.style.right = '20px';
                    box.style.setProperty('background', '#333', 'important');
                    box.style.setProperty('color', '#fff', 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                        box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);
                    // Navegação por teclado
                    window.addEventListener('keydown', keyHandler);
                    function keyHandler(e) {
                        if (box.style.display !== 'block') return;
                        if (e.key === 'ArrowRight') { idx = (idx + 1) % prefeitos.length; render(); }
                        if (e.key === 'ArrowLeft') { idx = (idx - 1 + prefeitos.length) % prefeitos.length; render(); }
                    }
                    function render() {
                        const p = prefeitos[idx];
                        const foto = p.foto ? p.foto : 'placeholder_prefeito.jpg';
                        const periodos = (p.periodos && p.periodos.length) ? p.periodos.join('<br>') : '<i>Períodos não informados</i>';
                        // Linhas zebra para períodos e observação
                        let zebra = '';
                        if (p.periodos && p.periodos.length) {
                            zebra += `<div style='margin-bottom:2px;'><b>Período(s):</b></div>`;
                            p.periodos.forEach((per, i) => {
                                zebra += `<div style='background:${i%2===0?'#333':'#292929'};color:#fff;padding:2px 6px;border-radius:3px;'>${per}</div>`;
                            });
                        }
                        if (p.observacao) {
                            zebra += `<div style='margin-top:6px;'><b>Obs.:</b></div>`;
                            zebra += `<div style='background:#292929;color:#fff;padding:2px 6px;border-radius:3px;'>${p.observacao}</div>`;
                        }
                        box.innerHTML = `
                            <div style='text-align:center;color:#fff;'>
                                <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>Prefeitos de São Gabriel</div>
                                <b style='font-size:17px;'>${p.nome}</b><br><br>
                                <img src='${foto}' alt='${p.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:#444;'>
                                <div style='margin-top:12px;text-align:left;font-size:15px;'>
                                    ${zebra}
                                </div>
                                <div style='display:flex;justify-content:space-between;margin-top:12px;'>
                                    <button id='prefeitos-prev' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#aaf;'>${idx + 1} / ${prefeitos.length}</span>
                                    <button id='prefeitos-next' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                                <button id='prefeitos-close' style='margin-top:14px;background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button>
                            </div>`;
                        document.getElementById('prefeitos-prev').onclick = () => { idx = (idx - 1 + prefeitos.length) % prefeitos.length; render(); };
                        document.getElementById('prefeitos-next').onclick = () => { idx = (idx + 1) % prefeitos.length; render(); };
                        document.getElementById('prefeitos-close').onclick = () => {
                            // Remove o box do DOM ao fechar
                            if (box.parentNode) box.parentNode.removeChild(box);
                            window.removeEventListener('keydown', keyHandler);
                        };
                        // Trigger animação de entrada
                        setTimeout(() => {
                            box.style.transform = 'translateX(0)';
                            box.style.opacity = '1';
                            box.style.display = 'block';
                        }, 10);
                    }
                    render();
                }
                
                // Carrossel para Homens Ilustres (foto + resumo + fonte)
                function showIlustresCarousel(startIndex = 0) {
                    if (!ilustres || !ilustres.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), ilustres.length - 1);
                    let oldBox = document.getElementById('ilustres-box');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'ilustres-box';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                    box.style.right = '20px';
                    box.style.setProperty('background', '#333', 'important');
                    box.style.setProperty('color', '#fff', 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);

                    function render() {
                        const it = ilustres[idx];
                        const foto = it.foto ? it.foto : 'placeholder_prefeito.jpg';
                        box.innerHTML = `
                            <div style='text-align:center;color:#fff;'>
                                <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>Homens Ilustres</div>
                                <b style='font-size:17px;'>${it.nome}</b><br><br>
                                <img src='${foto}' alt='${it.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:#444;'>
                                <div style='margin-top:12px;text-align:left;font-size:14px;color:#ddd;'>${it.resumo}</div>
                                <div style='display:flex;justify-content:space-between;margin-top:12px;'>
                                    <button id='ilustres-prev' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#aaf;'>${idx + 1} / ${ilustres.length}</span>
                                    <button id='ilustres-next' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                                <div style='margin-top:10px;display:flex;gap:8px;justify-content:center;'>
                                    ${it.fonte ? `<a href='${it.fonte}' target='_blank' style='color:#9fd;text-decoration:underline;padding:6px 10px;background:#223;border-radius:4px;'>Fonte</a>` : ''}
                                    <button id='ilustres-close' style='background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 12px;cursor:pointer;'>Fechar</button>
                                </div>
                            </div>`;
                        document.getElementById('ilustres-prev').onclick = () => { idx = (idx - 1 + ilustres.length) % ilustres.length; render(); };
                        document.getElementById('ilustres-next').onclick = () => { idx = (idx + 1) % ilustres.length; render(); };
                        document.getElementById('ilustres-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                        setTimeout(() => {
                            box.style.transform = 'translateX(0)';
                            box.style.opacity = '1';
                            box.style.display = 'block';
                        }, 10);
                    }
                    render();
                }
                lendas.forEach((lenda, idx) => {
                    const entity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lenda.position.lon, lenda.position.lat, 5), // 5 metros acima do solo
                        billboard: {
                            image: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            width: 40,
                            height: 40,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        lendaId: idx
                    });
                    lendaEntities.push(entity);
                });

                // Função para mostrar infobox de lenda com carrossel
                function showLendaInfobox(idx) {
                    const lenda = lendas[idx];
                    if (!lenda) return;
                    let oldBox = document.getElementById('infobox-lenda');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'infobox-lenda';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                        box.style.right = '20px';
                    box.style.setProperty('background', '#494949', 'important');
                    box.style.setProperty('color', '#fff', 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '340px';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                        box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    box.style.overflowY = 'auto';
                    document.body.appendChild(box);

                    // Zebra para descrição longa
                    let zebraDesc = '';
                    if (lenda.description) {
                        let descParts = lenda.description.split(/<br\s*\/?><br\s*\/?/);
                        zebraDesc = descParts.map((part, i) => `<div style='background:${i%2===0?'#333':'#292929'};color:#fff;padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                    }

                    let carousel = '';
                    if (lenda.images && lenda.images.length > 0) {
                        if (lenda.images.length === 1) {
                            carousel = `<div style="text-align:center;"><img id="carousel-img" src="${lenda.images[0]}" class="img-lenda" /></div>`;
                        } else {
                            carousel = `
                            <div id="carousel-lenda" style="text-align:center;">
                                <img id="carousel-img" src="${lenda.images[0]}" class="img-lenda" />
                                <br>
                                <button id="prev-img" style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                <span id="img-indicator" style='color:#aaf;'>1/${lenda.images.length}</span>
                                <button id="next-img" style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                            </div>`;
                        }
                    }
                    box.innerHTML = `
                        <div style='text-align:center;color:#fff;'>
                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>${lenda.title}</div>
                            ${carousel}
                            <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebraDesc}</div>
                            <div style='margin-top:12px;'><button id='close-infobox-lenda' style='background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button></div>
                        </div>
                    `;
                    document.getElementById('close-infobox-lenda').onclick = () => {
                        if (box.parentNode) box.parentNode.removeChild(box);
                    };
                    // Carrossel de imagens
                    if (lenda.images && lenda.images.length > 1) {
                        let idxImg = 0;
                        const imgEl = document.getElementById('carousel-img');
                        const indicator = document.getElementById('img-indicator');
                        document.getElementById('prev-img').onclick = () => {
                            idxImg = (idxImg - 1 + lenda.images.length) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${lenda.images.length}`;
                        };
                        document.getElementById('next-img').onclick = () => {
                            idxImg = (idxImg + 1) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${lenda.images.length}`;
                        };
                    }
                    // Animação de entrada
                    setTimeout(() => {
                        box.style.transform = 'translateX(0)';
                        box.style.opacity = '1';
                        box.style.display = 'block';
                    }, 10);
                }

                // Adiciona OSM Buildings tileset (sempre antes do KML)
                const buildingsTileset = await Cesium.createOsmBuildingsAsync();
                // Offset vertical em metros (ajuste conforme necessário)
                const osmOffset = 0;
                const osmTranslation = Cesium.Cartesian3.fromElements(0,0, osmOffset, new Cesium.Cartesian3());
                buildingsTileset.modelMatrix = Cesium.Matrix4.fromTranslation(osmTranslation);
                viewer.scene.primitives.add(buildingsTileset);
                // Garantir estado inicial: ocultar OSM (definimos explicitamente false aqui
                // para evitar usar a variável antes de sua declaração)
                buildingsTileset.show = false;

                // Botão para mostrar/ocultar OSM temporariamente
                // Inicialmente mantemos as OSM ocultas (não mostrar sobre nossos GLBs)
                let osmVisible = false;
                const activeGlbs = new Set(); // ids de prédios que atualmente exibem GLB (detalhe)
                // Handler do botão toggle-osm-btn está temporariamente oculto na UI.
                // Mantivemos a lógica abaixo comentada para referência futura (re-ativar se precisar obter elevação/coords):
                /*
                document.getElementById('toggle-osm-btn').onclick = function() {
                    osmVisible = !osmVisible;
                    updateTilesetShowForOSM(osmVisible);
                };
                */

                // Adiciona GLBs lowpoly ao iniciar (inclusive monumentos), mantendo como padrão as OSM originais visíveis
                // glbEntities[id] pode ser: Entity (low), Entity (detalhe único) ou Array<Entity> (detalhe multi-blocos)
                let glbEntities = {};
                // Helper para atualizar o estilo do tileset conforme osmVisible e quais GLBs estão ativos
                function updateTilesetShowForOSM(osmOn) {
                    if (!buildingsTileset) return;
                    if (!osmOn) {
                        // ocultar todo tileset
                        buildingsTileset.show = false;
                        return;
                    }
                    // Mostrar tileset, mas ocultar elementos que possuem GLB ativo ou que
                    // já têm um modelo low (uri_base) atualmente presente como entidade.
                    buildingsTileset.show = true;

                    // Reunir lista de IDs cuja OSM deve ser ocultada:
                    // - todos os ids que têm uri_base (temos um modelo low para eles)
                    // - além dos activeGlbs (detalhes abertos)
                    const hideSet = new Set();
                    // adiciona IDs que possuem uri_base (não queremos que o tileset OSM sobreponha nossos lows)
                    Object.keys(buildingsMap).forEach(id => {
                        const d = buildingsMap[id];
                        if (d && d.uri_base) hideSet.add(id);
                    });
                    // adiciona GLBs detalhados ativos (redundante em muitos casos, mas seguro)
                    activeGlbs.forEach(id => hideSet.add(id));

                    if (hideSet.size === 0) {
                        // sem ids a esconder: mostra tudo
                        buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                            show: true,
                            color: "color('white', 1)"
                        });
                        return;
                    }

                    // Construir condições corretamente: cada condição é uma expressão que
                    // compara ${elementId} com o id string e retorna false para ocultar.
                    const conds = [];
                    hideSet.forEach(hid => {
                        conds.push([`\${elementId} === '${hid}'`, false]);
                    });
                    conds.push([true, true]);
                    buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                        show: { conditions: conds }
                    });
                }
                function addLowModel(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.uri_base) return;
                    // Remove versões anteriores (low ou detail)
                    removeDetailModel(id);
                    const entLowExisting = viewer.entities.getById(id + '_low');
                    if (entLowExisting) viewer.entities.remove(entLowExisting);
                    const ent = viewer.entities.add({
                        id: id + '_low',
                        position: data.position,
                        orientation: Cesium.Transforms.headingPitchRollQuaternion(
                            data.position,
                            data.orientation
                        ),
                        model: {
                            uri: data.uri_base,
                            maximumScale: 20000,
                            heightReference: Cesium.HeightReference.NONE,
                            shadows: Cesium.ShadowMode.ENABLED
                        }
                    });
                    glbEntities[id] = ent; // referencia ao low
                    // Ao garantir o low, removemos id de activeGlbs (se estava)
                    if (activeGlbs.has(id)) {
                        activeGlbs.delete(id);
                        updateTilesetShowForOSM(osmVisible);
                    }
                }
                function addDetailModel(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.uri_detail) return;
                    // Remove low anterior
                    const low = viewer.entities.getById(id + '_low');
                    if (low) viewer.entities.remove(low);
                    // uri_detail pode ser string ou array
                    if (Array.isArray(data.uri_detail)) {
                        const parts = [];
                        data.uri_detail.forEach((uri, idx) => {
                            const ent = viewer.entities.add({
                                id: id + '_detail_' + idx,
                                position: data.position,
                                orientation: Cesium.Transforms.headingPitchRollQuaternion(
                                    data.position,
                                    data.orientation
                                ),
                                model: {
                                    uri: uri,
                                    maximumScale: 20000,
                                    heightReference: Cesium.HeightReference.NONE,
                                    shadows: Cesium.ShadowMode.ENABLED
                                }
                            });
                            parts.push(ent);
                        });
                        glbEntities[id] = parts; // array de partes
                        // marca como GLB ativo
                        activeGlbs.add(id);
                        updateTilesetShowForOSM(osmVisible);
                    } else {
                        const ent = viewer.entities.add({
                            id: id, // detalhe único usa id puro
                            position: data.position,
                            orientation: Cesium.Transforms.headingPitchRollQuaternion(
                                data.position,
                                data.orientation
                            ),
                            model: {
                                uri: data.uri_detail,
                                maximumScale: 20000,
                                heightReference: Cesium.HeightReference.NONE,
                                shadows: Cesium.ShadowMode.ENABLED
                            }
                        });
                        glbEntities[id] = ent;
                        // marca como GLB ativo
                        activeGlbs.add(id);
                        updateTilesetShowForOSM(osmVisible);
                    }
                }
                function removeDetailModel(id) {
                    const current = glbEntities[id];
                    if (!current) return;
                    if (Array.isArray(current)) {
                        current.forEach(ent => viewer.entities.remove(ent));
                    } else if (current && current.id && (current.id.endsWith('_low') || current.id === id)) {
                        // handled elsewhere
                    } else {
                        viewer.entities.remove(current);
                    }
                    // Mantém chave para recriar low depois
                }
                // Inicial: adiciona somente lows (exceto plano 999999999)
                Object.keys(buildingsMap).forEach(id => {
                    if (id === '999999999') return;
                    addLowModel(id);
                });

                // Evento de clique para mostrar ID e coordenadas do prédio OSM
                // Handler único para clique
                viewer.screenSpaceEventHandler.setInputAction(function (click) {
                    console.log('Clique detectado', click.position);
                    const pickedObject = viewer.scene.pick(click.position);
                    // Obtém coordenadas do clique
                    const cartesian = viewer.scene.pickPosition(click.position);
                    let coords = null;
                    if (cartesian) {
                        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                        const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(6);
                        const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(6);
                        const height = cartographic.height.toFixed(2);
                        coords = { lon, lat, height };
                    }
                    if (Cesium.defined(pickedObject)) {
                        // Clique em marcador de lenda
                        if (pickedObject.id && pickedObject.id.lendaId !== undefined) {
                            showLendaInfobox(pickedObject.id.lendaId);
                            return;
                        }
                        // Clique no marcador de prefeitos
                        if (pickedObject.id && pickedObject.id.id === 'prefeitura_prefeitos_marker') {
                            showPrefeitosCarousel();
                            return;
                        }
                        // marcador de marechais agora é um botão DOM; clique no mapa não aciona
                        // Clique em OSM
                        if (pickedObject.getProperty) {
                            const elementId = pickedObject.getProperty('elementId');
                            if (elementId) {
                                console.log('[OSM] ID do prédio:', elementId, 'Coordenadas:', coords);
                                if (buildingsMap[elementId]) {
                                    toggleOsmAndGlb(elementId);
                                } else {
                                    // Mostra infobox simples para OSM sem GLB
                                    let oldBox = document.getElementById('infobox');
                                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                                    let box = document.createElement('div');
                                    box.id = 'infobox';
                                    box.style.position = 'fixed';
                                    box.style.top = '70px';
                                        box.style.right = '20px';
                                    box.style.setProperty('background', '#494949', 'important');
                                    box.style.setProperty('color', '#fff', 'important');
                                    box.style.border = '1.5px solid #aaa';
                                    box.style.padding = '14px';
                                    box.style.zIndex = 30;
                                    box.style.width = '320px';
                                    box.style.maxWidth = '95vw';
                                    box.style.maxHeight = '70vh';
                                    box.style.overflowY = 'auto';
                                    box.style.boxShadow = '0 2px 16px #000a';
                                    box.style.borderRadius = '10px';
                                    box.style.fontFamily = 'sans-serif';
                                        box.style.transform = 'translateX(380px)';
                                    box.style.opacity = '0';
                                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                                    document.body.appendChild(box);
                                    box.innerHTML = `
                                        <div style='text-align:center;color:#fff;'>
                                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>Prédio OSM</div>
                                            <small style='color:#ccc;'>ID: ${elementId}</small><br><br>
                                            <div style='margin-top:12px;text-align:left;font-size:15px;'>
                                                Coordenadas:<br>
                                                <span style='color:#aaf;'>${coords ? `${coords.lat}, ${coords.lon} (alt: ${coords.height}m)` : 'Indisponível'}</span>
                                            </div>
                                            <div style='margin-top:12px;'><button id='close-infobox' style='background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button></div>
                                        </div>
                                    `;
                                    document.getElementById('close-infobox').onclick = () => {
                                        if (box.parentNode) box.parentNode.removeChild(box);
                                    };
                                    setTimeout(() => {
                                        box.style.transform = 'translateX(0)';
                                        box.style.opacity = '1';
                                        box.style.display = 'block';
                                    }, 10);
                                }
                            } else {
                                console.log('[OSM] Nenhum elementId encontrado. Coordenadas:', coords);
                            }
                            return;
                        }
                            // Clique em marcador turístico
                            if (pickedObject && pickedObject.id && pickedObject.id.tourismId) {
                                const tid = pickedObject.id.tourismId;
                                const p = tourismPoints.find(x => x.id === tid);
                                if (p) {
                                    // mostra um infobox simples
                                    let old = document.getElementById('tourism-infobox');
                                    if (old) old.parentNode.removeChild(old);
                                    const box = document.createElement('div');
                                    box.id = 'tourism-infobox';
                                    box.style.position = 'fixed';
                                    box.style.top = '10px';
                                    box.style.right = '20px';
                                    box.style.setProperty('background', '#494949', 'important');
                                    box.style.setProperty('color', '#fff', 'important');
                                    box.style.color = '#fff';
                                    box.style.padding = '10px';
                                    box.style.zIndex = 70;
                                    box.style.border = '1px solid #666';
                                    box.style.borderRadius = '8px';
                                    box.innerHTML = `<div style='font-weight:bold;margin-bottom:6px;'>${p.name}</div>
                                        <div style='display:flex;gap:6px;flex-wrap:wrap;align-items:center;'>
                                            <button id='tourism-open-page' style='padding:6px;'>Abrir página</button>
                                            ${p.infoUrl ? `<a id='tourism-more-info' href='${p.infoUrl}' target='_blank' style='color:#9fd;text-decoration:underline;font-size:13px;margin-left:4px;'>Mais informações</a>` : ''}
                                            <button id='tourism-close' style='padding:6px;'>Fechar</button>
                                        </div>`;
                                    document.body.appendChild(box);
                                    document.getElementById('tourism-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                                    document.getElementById('tourism-open-page').onclick = () => { if (p.pageUrl) window.open(p.pageUrl, '_blank'); };
                                }
                                return;
                            }
                        // Clique em GLB lowpoly de qualquer prédio
                        if (pickedObject.id && pickedObject.id.id && pickedObject.id.id.endsWith('_low')) {
                            const idBase = pickedObject.id.id.replace('_low', '');
                            const data = buildingsMap[idBase];
                            if (data && data.uri_detail) {
                                addDetailModel(idBase);
                                showInfobox(idBase);
                            }
                            return;
                        }
                        // Clique em GLB detalhado (único ou parte). Detecta baseId.
                        if (pickedObject.id && pickedObject.id.id) {
                            let pickedId = pickedObject.id.id;
                            let baseId = pickedId;
                            if (/(_detail_\d+)$/.test(pickedId)) {
                                baseId = pickedId.replace(/_detail_\d+$/, '');
                            }
                            if (buildingsMap[baseId] && glbEntities[baseId]) {
                                showInfobox(baseId);
                                return;
                            }
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                // Lógica de alternância OSM/GLB
                // ...existing code...

                // Cria/mostra infobox
                function showInfobox(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.info) return;
                    let oldBox = document.getElementById('infobox');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'infobox';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                    box.style.right = '20px';
                    box.style.setProperty('background', '#494949', 'important');
                    box.style.setProperty('color', '#fff', 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.maxWidth = '95vw';
                    box.style.maxHeight = '70vh';
                    box.style.overflowY = 'auto';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);

                    // Zebra para descrição longa
                    let zebraDesc = '';
                    if (data.info.description) {
                        let descParts = data.info.description.split(/<br\s*\/?><br\s*\/?/);
                        zebraDesc = descParts.map((part, i) => `<div style='background:${i%2===0?'#333':'#292929'};color:#fff;padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                    }

                    let extraBtn = '';
                    if (data.uri_base && data.uri_detail) {
                        extraBtn = `<button id='back-to-low' style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>Voltar ao modelo simplificado</button> `;
                    }
                    let carousel = '';
                    if (data.info.images && data.info.images.length > 0) {
                        if (data.info.images.length === 1) {
                            carousel = `<div style="text-align:center;"><img id="carousel-img-glb" src="${data.info.images[0]}" class="img-building" /></div>`;
                        } else {
                            carousel = `
                            <div id="carousel-glb" style="text-align:center;">
                                <img id="carousel-img-glb" src="${data.info.images[0]}" class="img-building" />
                                <br>
                                <button id="prev-img-glb" style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                <span id="img-indicator-glb" style='color:#aaf;'>1/${data.info.images.length}</span>
                                <button id="next-img-glb" style='background:#444;color:#fff;border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                            </div>`;
                        }
                    }
                    box.innerHTML = `
                        <div style='text-align:center;color:#fff;position:relative;min-height:120px;'>
                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#aaf;'>${data.info.title}</div>
                            <br>
                            ${carousel}
                            <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebraDesc}</div>
                            <div style='height:48px;'></div>
                            <div style='position:sticky;bottom:0;left:0;width:100%;background:#222;padding-top:8px;padding-bottom:8px;z-index:2;display:flex;gap:8px;justify-content:center;box-shadow:0 -2px 8px #000a;'>
                                ${extraBtn}<button id='close-infobox' style='background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('close-infobox').onclick = () => {
                        if (box.parentNode) box.parentNode.removeChild(box);
                    };
                    // Carrossel de imagens GLB
                    if (data.info.images && data.info.images.length > 1) {
                        let idxImg = 0;
                        const imgEl = document.getElementById('carousel-img-glb');
                        const indicator = document.getElementById('img-indicator-glb');
                        document.getElementById('prev-img-glb').onclick = () => {
                            idxImg = (idxImg - 1 + data.info.images.length) % data.info.images.length;
                            imgEl.src = data.info.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${data.info.images.length}`;
                        };
                        document.getElementById('next-img-glb').onclick = () => {
                            idxImg = (idxImg + 1) % data.info.images.length;
                            imgEl.src = data.info.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${data.info.images.length}`;
                        };
                    }
                    if (data.uri_base && data.uri_detail) {
                        document.getElementById('back-to-low').onclick = () => {
                            // Remove detalhe(s) e re-adiciona low
                            const current = glbEntities[id];
                            if (Array.isArray(current)) {
                                current.forEach(ent => viewer.entities.remove(ent));
                            } else if (current) {
                                // pode ser entidade detalhada única
                                if (current.id && !current.id.endsWith('_low')) {
                                    viewer.entities.remove(current);
                                }
                            }
                            // marca que este id não tem mais GLB ativo
                            if (activeGlbs.has(id)) {
                                activeGlbs.delete(id);
                                updateTilesetShowForOSM(osmVisible);
                            }
                            addLowModel(id);
                            if (box.parentNode) box.parentNode.removeChild(box);
                        };
                    }
                    // Animação de entrada
                    setTimeout(() => {
                        box.style.transform = 'translateX(0)';
                        box.style.opacity = '1';
                        box.style.display = 'block';
                    }, 10);
                }

                function toggleOsmAndGlb(id) {
                    // Quando clicar em OSM de um prédio com GLB: abre detalhe e garante que
                    // o OSM deste prédio será ocultado enquanto o GLB estiver ativo.
                    // addDetailModel já adiciona id em activeGlbs e chama updateTilesetShowForOSM.
                    const prev = glbEntities[id];
                    if (Array.isArray(prev)) prev.forEach(ent => viewer.entities.remove(ent));
                    else if (prev) viewer.entities.remove(prev);
                    addDetailModel(id);
                }

                // Handler duplicado removido para evitar sobrescrita

            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        }

        init();
    </script>
</body>

</html>